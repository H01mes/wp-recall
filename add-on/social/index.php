<?phprcl_enqueue_style('social',__FILE__);add_filter('admin_options_wprecall','get_admin_social_page_content');function get_admin_social_page_content($content){    $opt = new Rcl_Options(get_key_addon_rcl(pathinfo(__FILE__)));            $content .= $opt->options(        'Настройки социальной стены',        $opt->option_block(            array(                $opt->tab_name('Стена'),                                $opt->label('Социальная стена'),                $opt->option('select',array(                    'name'=>'social_wall_rcl',                    'options'=>array('Отключена','Включена')                )),                                $opt->label('Социальные ссылки пользователя'),                $opt->option('select',array(                    'name'=>'social_link_rcl',                    'options'=>array('Отключена','Включена')                )),                $opt->label('Ширина социальной стены (в пикселях)'),                $opt->option('text',array('name'=>'width_comment_form_vk'))            )        )    );	    return $content;}add_block_rcl('header','add_vk_com_script_header_rcl');function add_vk_com_script_header_rcl(){	global $user_LK,$rcl_options;	$social_meta = unserialize(get_the_author_meta('social_meta_rcl',$user_LK));	if(!$rcl_options['social_wall_rcl'])return false;	if(!$social_meta['vk']['api_id']&&!$social_meta['ok']['group_id'])return false;	echo '<script type="text/javascript" src="//vk.com/js/api/openapi.js"></script>	<script type="text/javascript">VK.init({apiId: '.$social_meta['vk']['api_id'].', onlyWidgets: true});</script>';}add_filter('rcl_postdesc_user','add_social_link_rcl',7,2);add_filter('rcl_description_user','add_social_link_rcl',10,2);add_block_rcl('content','get_slink_rcl',array('id'=>'sl-block','order'=>7));function get_slink_rcl($user_LK){    global $rcl_options;    $social_meta = unserialize(get_the_author_meta('social_meta_rcl',$user_LK));    if(!$rcl_options['social_link_rcl'])return false;    $linklist = '';    foreach((array)$social_meta['link'] as $key=>$value){            if($value){                     switch($key){                            case 'vk_link': $title='Я Вконтакте';break;                            case 'ok_link': $title='Я в Одноклассниках';break;                            case 'gp_link': $title='Я в Google+';break;                            case 'lj_link': $title='Я в LiveJournal';break;                            case 'mm_link': $title='Я в Мой мир';break;                            case 'tw_link': $title='Я в Twitter';break;                            case 'fb_link': $title='Я в Facebook';break;                            case 'mail_link': $title='Написать мне';$value="mailto:".$value; break;                    }                    $linklist .='<li class="'.$key.' social-link"><a title="'.$title.'" rel="nofollow" target="_blank" href="'.$value.'"></a></li>';            }    }    if(!$linklist) return false;    return '<ul id="social-link-rcl">'.$linklist.'</ul>';}function add_social_link_rcl($content,$user_LK){    $content .= get_slink_rcl($user_LK);    return $content;}add_action('init','chek_view_socwall');function chek_view_socwall(){    global $rcl_options;    if(!isset($rcl_options['social_wall_rcl'])) return false;    if($rcl_options['social_wall_rcl'])        add_tab_rcl('social','user_recall_social_block','Стена',array('class'=>'fa-th-large','order'=>2));}function user_recall_social_block($author_lk){	global $rcl_options;	$social_meta = unserialize(get_the_author_meta('social_meta_rcl',$author_lk));	if(!$social_meta['vk']['api_id']&&!$social_meta['ok']['group_id'])return '<h3>Не указаны настройки для выводимых виджетов</h3>';		$width = $rcl_options['width_comment_form_vk'];	if(!$width) $width = 496;	if($social_meta['vk']['feed']) $social_block .= '<div style="width: 200px;margin-top: -18px;"><div id="vk_subscribe"></div></div>		<script type="text/javascript">VK.Widgets.Subscribe("vk_subscribe", {soft: 1}, '.$social_meta['vk']['user_id'].');</script>';			if($social_meta['vk']['group']) $social_block .= '<div id="vk_groups"></div>	<script type="text/javascript">VK.Widgets.Group("vk_groups", {mode: 0, width: "'.$width.'", height: "290"}, '.$social_meta['vk']['group_id'].');</script>';		if($social_meta['ok']['group']) $social_block .= '<div id="ok_group_widget"></div>	<script>	!function (d, id, did, st) {	  var js = d.createElement("script");	  js.src = "http://connect.ok.ru/connect.js";	  js.onload = js.onreadystatechange = function () {	  if (!this.readyState || this.readyState == "loaded" || this.readyState == "complete") {		if (!this.executed) {		  this.executed = true;		  setTimeout(function () {			OK.CONNECT.insertGroupWidget(id,did,st);		  }, 0);		}	  }}	  d.documentElement.appendChild(js);	}(document,"ok_group_widget","'.$social_meta['ok']['group_id'].'","{width:'.$width.',height:335}");	</script>';	if($social_meta['vk']['poll']) $social_block .= '<div id="vk_poll"></div>		<script type="text/javascript">VK.Widgets.Poll("vk_poll", {width: "'.$width.'"}, "'.$social_meta['vk']['poll_id'].'");</script>';			if($social_meta['vk']['comments']) $social_block .= '	<div id="vk_comments"></div>	<script type="text/javascript">	VK.Widgets.Comments("vk_comments", {limit: 10, width: "'.$width.'", attach: "*"});	</script>';	return $social_block;}//Выводим произвольные поля профиля на странице пользователя в админкеif (is_admin()):	add_action('profile_personal_options', 'social_profile_fields_recall');	add_action('edit_user_profile', 'social_profile_fields_recall');endif;function social_profile_fields_recall($user){	$social_meta = unserialize(get_the_author_meta('social_meta_rcl',$user->ID));	$field = '	<h3>Социальные настройки:</h3>	<table class="form-table">						'.get_data_social_table_rcl($user->ID).'	</table>';	echo $field;}add_filter('profile_options_rcl','add_profile_social_options',10,2);function add_profile_social_options($profile_block,$userdata){	$profile_block .= get_data_social_table_rcl($userdata->ID);	return $profile_block;}function get_option_soc_link($title,$idlink,$type='url'){    global $social_meta;    $soclink =  (isset($social_meta['link'][$idlink])) ? $social_meta['link'][$idlink] : '';    return '<tr>                <th><label for="'.$idlink.'">'.$title.':</label></th>                <td><input type="'.$type.'" name="social[link]['.$idlink.']" class="regular-text" id="'.$idlink.'" value="'.esc_attr( $soclink  ).'" maxlength="100"/></td>        </tr>';}function get_data_social_table_rcl($user_id){	global $rcl_options,$social_meta;	$social_meta = unserialize(get_the_author_meta('social_meta_rcl',$user_id));        $profile_block = '<table>';	if($rcl_options['social_link_rcl']) $profile_block .= '		<tr>			<th></th>			<td><h3>Социальные ссылки пользователя</h3></td>		</tr>';        $soclinks = array(            'mail_link'=>'Email для контакта',            'vk_link'=>'Вконтакте',            'ok_link'=>'Одноклассники',            'mm_link'=>'Мой мир (mail.ru)',            'lj_link'=>'Livejournal',            'fb_link'=>'Facebook',            'tw_link'=>'Twitter',            'gp_link'=>'Google+',        );                foreach($soclinks as $key=>$name){            if($key=='mail_link') $type='email';            else $type='url';            $profile_block .= get_option_soc_link($name,$key,$type);        }	if($rcl_options['social_wall_rcl']) $profile_block .= '<tr>			<th></th>			<td><h3>Настройки социальной стены</h3></td>		</tr>		<tr>			<td colspan="2"><h4><u>Основные настройки ВКонтакте</u></h4></td>					</tr>				<tr>			<th><label for="vk_api_id">API_ID ВК:</label></th>			<td><input type="text" name="social[vk][api_id]" class="regular-text" id="vk_api_id" value="'.esc_attr( $social_meta['vk']['api_id'] ).'" maxlength="100"/><br>Требуется для отображения виджетов ВК.</td>		</tr>		<tr>			<th><label for="vk_user_id">ID пользователя ВК:</label></th>			<td><input type="text" name="social[vk][user_id]" class="regular-text" id="vk_user_id" value="'.esc_attr( $social_meta['vk']['user_id'] ).'" maxlength="100"/><br>Требуется для отображения виджета "Подписаться".</td>		</tr>		<tr>			<td colspan="2"><h4><u>Отображение виджетов ВКонтакте</u></h4></td>					</tr>		<tr>			<th><label for="vk_comment">Виджет ВК "Подписаться":</label></th>			<td><input type="checkbox" name="social[vk][feed]" id="vk_feed" '.checked($social_meta['vk']['feed'],1,false).' value="1"/> отображать для посетителей вашей страницы</td>		</tr>		<tr>			<th><label for="vk_comment">Комментарии ВК:</label></th>			<td><input type="checkbox" name="social[vk][comments]" id="vk_comment" '.checked($social_meta['vk']['comments'],1,false).' value="1"/> отображать для посетителей вашей страницы</td>		</tr>		<tr>			<th><label for="vk_widget">Виджет опроса ВК:</label></th>			<td><input type="checkbox" name="social[vk][poll]" id="vk_poll" '.checked($social_meta['vk']['poll'],1,false).' value="1"/> отображать для посетителей вашей страницы</td>		</tr>		<tr>			<th><label for="vk_poll_id">ID опроса:</label></th>			<td><input type="text" name="social[vk][poll_id]" class="regular-text" id="vk_poll_id" value="'.esc_attr( $social_meta['vk']['poll_id'] ).'" maxlength="100"/></td>		</tr>		<tr>			<th><label for="vk_group">Группа ВК:</label></th>			<td><input type="checkbox" name="social[vk][group]" id="vk_group" '.checked($social_meta['vk']['group'],1,false).' value="1"/> отображать для посетителей вашей страницы</td>		</tr>		<tr>			<th><label for="vk_group_id">ID группы:</label></th>			<td><input type="text" name="social[vk][group_id]" class="regular-text" id="vk_group_id" value="'.esc_attr( $social_meta['vk']['group_id'] ).'" maxlength="100"/></td>		</tr>				<tr>			<td colspan="2"><h4><u>Виджеты Одноклассников</u></h4></td>					</tr>		<tr>			<th><label for="ok_group_id">ID группы:</label></th>			<td><input type="text" name="social[ok][group_id]" class="regular-text" id="group_id" value="'.esc_attr( $social_meta['ok']['group_id'] ).'" maxlength="100"/></td>		</tr>		<tr>			<th><label for="ok_group">Группа Одноклассников:</label></th>			<td><input type="checkbox" name="social[ok][group]" id="ok_group" '.checked($social_meta['ok']['group'],1,false).' value="1"/> отображать для посетителей вашей страницы</td>		</tr>';                $profile_block .= '</table>';	return $profile_block;}//Сохраняем изменения в произвольных полях профиля со страницы пользователяadd_action('personal_options_update', 'rcl_save_profile_social_fields');add_action('edit_user_profile_update', 'rcl_save_profile_social_fields');function rcl_save_profile_social_fields($user_id) {	if ( !current_user_can( 'edit_user', $user_id ) ) return false;	if( !isset($_POST['social']) ) return false;		foreach((array) $_POST['social'] as $group=>$value ){		foreach((array) $value as $key=>$v ){			$noval=true;			if(!$v) continue;			if($group=='link'){								switch($key){					case 'vk_link': 						if ( false !== strpos($v, 'vk') ) break;						else $noval=false;					case 'ok_link': 						if ( false !== strpos($v, 'odnoklassniki') ) break;						else $noval=false;					case 'gp_link': 						if ( false !== strpos($v, 'google') ) break;						else $noval=false;					case 'lj_link':						if ( false !== strpos($v, 'livejournal') ) break;						else $noval=false;					case 'mm_link':						if ( false !== strpos($v, 'mail') ) break;						else $noval=false;					case 'tw_link':						if ( false !== strpos($v, 'twitter') ) break;						else $noval=false;					case 'fb_link':						if ( false !== strpos($v, 'facebook') ) break;						else $noval=false;					case 'mail_link': 						if ( is_email($v) ) break;						else $noval=false;				}							}			if(!$noval)	continue;			$vk_meta[$group][$key] = $v;					}	}	$vk_meta = serialize($vk_meta);	update_usermeta($user_id, 'social_meta_rcl', $vk_meta);					}?>