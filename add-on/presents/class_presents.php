<?php							class RCL_presents{	function __construct(){			}	function get_presents_list(){		global $wpdb,$user_ID;		$lk = $_POST['lk'];		if(!$user_ID) exit;				$presents = get_option('presents_data');				if(!$presents){			$log['result'] = 200;						exit;		}				$content = '<a class="close-popup" href="#"></a><h4 align="center">Доступные подарки</h4><ul id="presents-list">';		foreach($presents as $key=>$p){			$price = $p['price'].'p.';			if(!$p['price']) $price = 'Бесплатно';			$content .= '<li><a data="'.$key.'" class="present" href="#"><img src="'.$p['url'].'"></a><span class="present-price">'.$price.'</span></li>';		}		$content .= '</ul>';				$log['result'] = 100;		$log['content'] = $content;		echo json_encode($log);		exit;	}		function get_show_present(){		global $wpdb,$user_ID;		$id = $_POST['id'];		$lk = $_POST['lk'];				$presents = unserialize(get_the_author_meta('presents',$lk));				if(!$presents){			$log['result'] = 200;						exit;		}				$content = '<a class="close-popup" href="#"></a>';		if($user_ID==$lk) $content .= '<a href="#" id="present-'.$id.'" class="present_delete delete"></a>';		$content .= '<div id="present-box">';		foreach($presents as $key=>$p){			if($key!=$id) continue;			$content .= '<h4>Подарок от пользователя <a href="'.get_author_posts_url($p['author']).'">'.get_the_author_meta('display_name',$p['author']).'</a></h4><img src="'.$p['url'].'"></a>';		}		$content .= '</div>';				$log['result'] = 100;		$log['content'] = $content;		echo json_encode($log);		exit;	}		function add_present(){		global $wpdb,$user_ID;		$id = $_POST['id'];		$lk = $_POST['lk'];		if(!$user_ID) exit;				$presents = get_option('presents_data');				if(!$presents){			$log['result'] = 200;			$log['error']='Подарки не найдены!';			echo json_encode($log);						exit;		}		foreach($presents as $key=>$p){			if($key!=$id) continue;						$prez = unserialize(get_the_author_meta('presents',$lk));			foreach($prez as $pr){				if($pr['author']==$user_ID&&$pr['url']==$p['url']){					$log['result'] = 200;					$log['error']='Вы уже дарили этот подарок!';						echo json_encode($log);					exit;				}			}						if($p['price']){				$oldusercount = $wpdb->get_row("SELECT * FROM ".$wpdb->prefix."rmag_user_count WHERE user='$user_ID'");				$newusercount = "$oldusercount->count" - $p['price'];				if($newusercount<0){					$log['result'] = 200;					$log['error']='У вас недостаточно средств!';						echo json_encode($log);					exit;				}				$wpdb->update( $wpdb->prefix.'rmag_user_count', 						array( 'count' =>$newusercount),						array( 'user' =>$user_ID)					);									if(function_exists('add_wallet_history_row')) 					add_wallet_history_row($user_ID,$p['price'],'Приобретение подарка для '.get_the_author_meta('display_name',$lk),1);			}									if(!$prez) $cnt=0; 			else $cnt = count($prez);			$prez[$cnt]['author']=$user_ID;			$prez[$cnt]['url']=$p['url'];			update_usermeta($lk, 'presents', serialize($prez));			break;		}		$content .= '</ul>';				$log['result'] = 100;		$log['redirect'] = get_author_posts_url($lk);		echo json_encode($log);		exit;	}		function present_delete(){		global $wpdb,$user_ID;		if(!$user_ID) exit;		$id = $_POST['id'];				$prez = unserialize(get_the_author_meta('presents',$user_ID));				if(!$prez){			$log['result'] = 200;						exit;		}						foreach($prez as $key=>$pr){			if($key==$id){				unset($prez[$key]);				update_usermeta($user_ID, 'presents', serialize($prez));				$log['result'] = 100;				echo json_encode($log);				exit;			}		}	}}	?>