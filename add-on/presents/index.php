<?phprcl_enqueue_style('presents',__FILE__);add_block_rcl('sidebar','add_presents_button_lk',array('id'=>'pb-block','public'=>-1,'order'=>20));function add_presents_button_lk($author_lk){	global $user_ID;	if(!$user_ID||$user_ID==$author_lk) return false;		return get_button_rcl('Сделать подарок','#',array('icon'=>false,'class'=>'add-present-rcl','attr'=>false,'id'=>false));}function setup_field_scripts(){    wp_enqueue_style('thickbox');    wp_enqueue_script('present-scripts', plugins_url('js/admin.js',(__FILE__)), array('jquery', 'thickbox'));}add_action('admin_menu', 'presents_options_page_rcl',30);function presents_options_page_rcl(){	add_submenu_page( 'manage-wprecall', 'Подарки', 'Подарки', 'manage_options', 'manage-presents', 'presents_manage_rcl');}add_block_rcl('footer','show_presents_in_pageuser_rcl',array('gallery'=>'presents-list-user','title'=>'Полученные подарки','id'=>'pr-block','order'=>10,'public'=>1));function show_presents_in_pageuser_rcl($user_lk){	$presents = get_the_author_meta('presents',$user_lk);			if(!$presents) return false;	$content='';	foreach($presents as $key=>$data){				$content = '<li id="pr-'.$key.'"><a class="show-present" data="'.$key.'" href="#"><img title="Подарок от '.get_the_author_meta('display_name',$data['author']).'" src="'.$data['url'].'"></a></li>'.$content;	}		return $desc = '<ul class="data-list" id="presents-list-user">'.$content.'</ul>';}add_action('init', 'pre_save_presents_data');function pre_save_presents_data(){  if ( isset( $_POST['save-presents'] ) ) {	if( !wp_verify_nonce( $_POST['_wpnonce'], 'update-presents-rcl' ) ) return false;	$a=0;	foreach((array)$_POST['present']['url'] as $key=>$data){		if($_POST['present']['url'][$key]){			$presents[$a]['url'] = $_POST['present']['url'][$key];			$presents[$a]['price'] = $_POST['present']['price'][$key];			$a++;		}	}	if(isset($presents)) update_option('presents_data',$presents);	wp_redirect(get_bloginfo('wpurl').'/wp-admin/admin.php?page=manage-presents'); exit;  }}function get_present_data($p=false){	$pr = '<div style="clear:both;"><div class="alignleft">';	if($p) $pr .= '<img height="60" src="'.$p['url'].'">';	$pr .= '</div>Файл подарка<br />			<input type="url" class="present_url" name="present[url][]" value="'.$p['url'].'" style="width:50%" /> 				<a href="#" class="add_present_rcl button" style="display: inline-block;">Выбрать</a> 			Цена: <input type="text" class="present_price" name="present[price][]" value="'.$p['price'].'" size="4" />';	if(!$p) $pr .= '<a href="#" class="add_button_present button" style="display: inline-block;">+ Еще</a>';	$pr .= '</div>';		return $pr;}function presents_manage_rcl(){	setup_field_scripts();		$presents = get_option('presents_data');		$page = '<style>.alignleft{min-height:50px;width:100px;text-align:center;}</style>	<h2>Управление подарками Wp-Recall</h2>		<form class="nav-menus-php" action="" method="post">	'.wp_nonce_field('update-presents-rcl','_wpnonce',true,false).'	<div id="presents_manage_rcl" class="presents_manage" style="width:700px;">';		if($presents){		foreach($presents as $p){			$page .= get_present_data($p);		}	}		$page .= get_present_data();		$page .= '</div>		<p><input type="submit" value="Сохранить" name="save-presents" class="button button-primary button-large"></p>	</form>';		echo $page;}add_filter('file_scripts_rcl','get_scripts_presents_rcl');function get_scripts_presents_rcl($script){		$ajaxfile = "type: 'POST', data: dataString, dataType: 'json', url: rcl_url+'add-on/presents/ajax-request.php',";			$script .= "	jQuery('.add-present-rcl').click(function(){		var lk = parseInt(jQuery('.wprecallblock').attr('id').replace(/\D+/g,''));		var dataString = 'action=get_presents_list&user_ID='+user_ID+'&lk='+lk;		jQuery.ajax({			".$ajaxfile."			success: function(data){				if(data['result']==100){					jQuery('#rcl-overlay').fadeIn();					jQuery('#rcl-popup').html(data['content']);					var screen_top = jQuery(window).scrollTop();					var popup_h = jQuery('#rcl-popup').height();					var window_h = jQuery(window).height();					screen_top = screen_top + 60;					jQuery('#rcl-popup').css('top', screen_top+'px').delay(100).slideDown(400);									}else{					alert('Подарки не найдены!');				}							} 		});					return false;	});	jQuery('.present_delete').live('click',function(){			if(!confirm('Вы уверены?'))return false;		var id = parseInt(jQuery(this).attr('id').replace(/\D+/g,''));		var dataString = 'action=present_delete&user_ID='+user_ID+'&id='+id;		jQuery.ajax({			".$ajaxfile."			success: function(data){				if(data['result']==100){					jQuery('#rcl-popup').empty();					jQuery('#rcl-overlay').fadeOut();					jQuery('#presents-list-user #pr-'+id).remove();								}else{					alert('Подарок не найден!');				}							} 		});					return false;	});	jQuery('.show-present').click(function(){		var lk = parseInt(jQuery('.wprecallblock').attr('id').replace(/\D+/g,''));		var id = jQuery(this).attr('data');		var dataString = 'action=get_show_present&user_ID='+user_ID+'&id='+id+'&lk='+lk;		jQuery.ajax({			".$ajaxfile."			success: function(data){				if(data['result']==100){					jQuery('#rcl-overlay').fadeIn();					jQuery('#rcl-popup').html(data['content']);					var screen_top = jQuery(window).scrollTop();					var popup_h = jQuery('#rcl-popup').height();					var window_h = jQuery(window).height();					screen_top = screen_top + 60;					jQuery('#rcl-popup').css('top', screen_top+'px').delay(100).slideDown(400);									}else{					alert('Подарки не найдены!');				}							} 		});					return false;	});	jQuery('#presents-list a.present').live('click',function(){		if(!confirm('Вы уверены?'))return false;		var lk = parseInt(jQuery('.wprecallblock').attr('id').replace(/\D+/g,''));		var id = jQuery(this).attr('data');		var dataString = 'action=add_present&user_ID='+user_ID+'&id='+id+'&lk='+lk;		jQuery.ajax({			".$ajaxfile."			success: function(data){				if(data['result']==100){										jQuery('#rcl-popup').empty();					location.replace(data['redirect']);									}else{					alert(data['error']);				}						} 		});					return false;	});	";	return $script;}?>